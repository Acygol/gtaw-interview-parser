<!DOCTYPE html utf-8>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    </head>
    <body class="d-flex flex-column h-100 bg-dark text-light">
        <main class="flex-shrink-0">
            <div class="container">
                <h1 class="text-center">Generate interview topics</h1>
            </div>

            <div class="container">
                <form>
                    <div class="row">
                        <div class="col input-group mb-3">
                            <div class="input-group-prepend">
                              <span class="input-group-text">Interviewer's name:</span>
                            </div>
                            <input type="text" class="form-control" id="interviewerNameInput" placeholder="Firstname Lastname" aria-label="Interviewer's Name" /> 
                        </div>
                        <div class="col input-group mb-3">
                            <div class="input-group-prepend">
                              <span class="input-group-text">(badge number) #</span>
                            </div>
                            <input type="text" class="form-control" id="badgeNumberInput" placeholder="123456" aria-label="Badge number" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col input-group mb-3">
                            <div class="input-group-prepend">
                                <label class="input-group-text" for="rankSelection">Your rank:</label>
                            </div>
                            <select class="custom-select" id="rankSelection">
                                <option>Director of Recruitment</option>
                                <option>Assistant Director of Recruitment</option>
                                <option>Recruitment Officer</option>
                                <option>Probationary Recruitment Officer</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col input-group mb-3">
                            <div class="input-group-prepend">
                              <span class="input-group-text">Interviewee's name:</span>
                            </div>
                            <input type="text" class="form-control" id="intervieweeNameInput" placeholder="Firstname Lastname" aria-label="Interviewee's Name" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Other participants</span>
                            </div>
                            <textarea class="form-control" id="otherParticipantsInput" aria-label="Other participants" rows="6" placeholder="Add each person's name on a different line..."></textarea>
                        </div>
                    </div>

                    <div class="input-group my-3">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="logsFileInput">
                            <label class="custom-file-label" for="logsFileInput">Choose chat log file (.txt)</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="logsContent">Output:</label>
                        <textarea class="form-control" id="logsContent" rows="20" readonly></textarea>
                    </div>
                </form>
            </div>
        </main>

        <footer class="footer mt-auto py-2">
            <div class="text-muted text-right px-2">Made by Acygol</div>
        </footer>

        <script>
            /*
            //
            //  Written and developed by Acygol.
            //
            //  Initially used for the Training and Recruitment division of the 
            //  GTAW Fire Department, repurposed for the GTAW State Fire Marshals.
            //
            //  Edit, copy, do whatever. I don't care.
            //
            */

            // Template variables
            const TPLTVAR_INTERVIEWEE_NAME        = '$INTERVIEWEE_NAME$';        // The name of the interviewee
            const TPLTVAR_PREINTERVIEW_TEXT       = '$PREINTERVIEW_TEXT$';       // The preinterview text - any dialog/RP before the first question
            const TPLTVAR_QUESTIONS_CONTAINER     = '$QUESTIONS_CONTAINER$';     // Replaced by a string containing all the question templates combined
            const TPLTVAR_QUESTION_NUMBER         = '$QUESTION_NUMBER$';         // The current question number
            const TPLTVAR_QUESTION_TEXT           = '$QUESTION_TEXT$';           // The question itself (should be limited to a single line)
            const TPLTVAR_QUESTION_ANSWER_CONTENT = '$QUESTION_ANSWER_CONTENT$'; // The answer and any dialog/RP related to the question

            // The main template is the parent template; individual question templates are parsed
            // and then embedded within this template.
            const MAIN_TEMPLATE = `[divbox=white]
            [hr][/hr]
            [center][img]https://www.upload.ee/image/12808254/recruitment.png[/img][/center] 
            [hr][/hr]

            [center][size=150][font=AmerType Md BT]INTERVIEW - ${TPLTVAR_INTERVIEWEE_NAME}[/font][/size][/center]

            [hr][/hr]

            [justify]
            ${TPLTVAR_PREINTERVIEW_TEXT}
            ${TPLTVAR_QUESTIONS_CONTAINER}
            [/justify]
            [/divbox]
            `

            // Individual question template
            const QUESTION_TEMPLATE = `[hr][/hr]
            [b]Question #${TPLTVAR_QUESTION_NUMBER}: ${TPLTVAR_QUESTION_TEXT}[/b]

            ${TPLTVAR_QUESTION_ANSWER_CONTENT}`

            // Form data
            let g_InterviewerName = ''; // Interviewer name
            let g_IntervieweeName = ''; // Interviewee name
            let g_BadgeNumber = '';     // Interviewer's badge number
            let g_Participants = [];    // Interview participants to include

            // Handle the file selector element...
            const fileSelector = document.getElementById('logsFileInput');
            fileSelector.addEventListener('change', (event) => {
                const file = event.target.files[0];

                if (file.type && file.type.indexOf('text') === -1) {
                    console.log('File is not a text document.', file.type, file);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    g_InterviewerName   = document.getElementById('interviewerNameInput').value;
                    g_IntervieweeName   = document.getElementById('intervieweeNameInput').value;
                    g_BadgeNumber       = document.getElementById('badgeNumberInput').value;
                    g_Participants      = parseParticipants();

                    g_Participants.push(g_InterviewerName); // The interviewer is a participant
                    g_Participants.push(g_IntervieweeName); // The interviewee is a participant

                    logToInterview(event.target.result);
                };

                reader.readAsText(file);
            });

            function logToInterview(text) {
                const rankSelectionElem = document.getElementById('rankSelection');
                const rankSelectionId = rankSelectionElem.options.selectedIndex;
                const rankName = rankSelectionElem.options[rankSelectionId].text; // Interviewer's rank

                parseChatLog(text.split('\n'));
            }

            function parseParticipants() {
                let participants = [];
                let participantsText = document.getElementById('otherParticipantsInput').value;
                for (let i = 0; i < participantsText.split('\n').length; i++) {
                    participants.push(participantsText[i]);
                }
                return participants;
            }

            /*
            //  An interview starts and ends the moment the following sentence is uttered:
            //      "[faction rank] [full name], badge number [badge number], starting/ending interview..."
            //
            //  The only unique element in this sentence is the interviewer's badge number. It is
            //  highly unlikely that the badge number is repeated anywhere, but just to make sure, we
            //  extend the pattern to include the word "interview". The chance that these two elements
            //  are put together in a non-interview context is /extremely/ low.
            //  
            //  An interview is marked as "ongoing" in the algorithm when both these elements are
            //  uttered in the same line. Examples:
            //      "Jeffrey Kendall, badge number 52511, starting interview ..."
            //      "Recruitment Director, badge number 8975412, ending interview ..."
            //
            //  As long as both the badge number and the word 'interview' are in the same line,
            //  any variation will do.
            */
            function parseChatLog(lines) {
                let allQuestions = '';  // A string containing all formatted questions
                let q_Header     = '';  // A string containing the question itself
                let q_Content    = '';  // A string containing all dialog related to a single question, except for the question itself
                let q_Count      = 0;   // Question counter

                let isDescription = false; // Keeps track of whether the current line belongs to the description text of any participant

                let preinterviewContent = '';
                let isPreinterview = true;

                let isInterviewOngoing = false;

                for (let i = 0; i < lines.length; i++) {
                    // Remove timestamps...
                    lines[i] = lines[i].replace(/\[(\d)+:(\d)+:(\d)+\]/g, '');

                    // Trim endlines and whitespace from the beginning of the line and 
                    // the end...
                    lines[i] = lines[i].trim();

                    // The end/start pattern is encountered...
                    if (lines[i].includes(g_BadgeNumber) && lines[i].includes("interview")) {
                        // Toggle the interview state...
                        isInterviewOngoing = !isInterviewOngoing;

                        // The interview's ongoing state was /just/ toggled off,
                        // thus the interview has ended.
                        if (!isInterviewOngoing) {
                            q_Content += `${lines[i]}\r\n\r\n`;

                            // Commit the last question...
                            allQuestions += formatQuestion(q_Count + 1, q_Header, q_Content);

                            // Stop parsing the chat...
                            break;
                        }
                    }

                    // The interview hasn't started yet, so we don't care about the 
                    // current line.
                    if (!isInterviewOngoing) {
                        continue;
                    }

                    // Skip duplicate /ame lines...
                    if (i > 0 && isInterviewerAme(lines[i]) && isInterviewerAme(lines[i+1])) {
                        console.log(`line skipped (duplicate ame): ${lines[i]}`);
                        continue;
                    }

                    // Mark the start of a description and skip the line...
                    if (lines[i].startsWith('___Description')) {
                        isDescription = true;
                        continue;
                    }

                    // As long as the current line is part of the description, skip it...
                    if (isDescription) {
                        // Unless it starts with "Injuries:" which is the last line of a
                        // character's description.
                        if (lines[i].startsWith('Injuries:')) {
                            isDescription = false;
                            i++; // Skip the next line as well
                            continue;
                        } else {
                            // Skip the description line...
                            continue;
                        }
                    }

                    // If it's an irrelevant line; OOC chatter, various commands, adverts, etc.
                    // then skip those too. Also, if the line wasn't sent by any participant,
                    // then we don't care about it either.
                    if (isMetaLine(lines[i]) || !isLineSentByParticipant(lines[i])) {
                        continue;
                    }

                    // When the line is a roleplay emote, apply the color...
                    if (isRoleplayLine(lines[i])) {
                        lines[i] = `[color=#AD82CE]${lines[i]}[/color]`;
                    }

                    // The line is a question...
                    if (lines[i].trim().endsWith('?') && lines[i].startsWith(g_InterviewerName)) {
                        // The value of q_Content is the preinterview when isPreinterview = true
                        if (isPreinterview) {
                            preinterviewContent = q_Content;
                            isPreinterview = false;
                        } else {
                            // Add the formatted question to the questions container...
                            allQuestions += formatQuestion(q_Count, q_Header, q_Content);
                        }

                        // Increment the question counter...
                        q_Count++;
                        
                        // Start a new formatted question...
                        q_Header  = lines[i].replace(`${g_InterviewerName} says: `, ''); // remove the "says: " part from the line
                        q_Content = '';
                    } else {
                        // Add the line to the current question if it wasn't the question...
                        q_Content += `${lines[i]}\r\n\r\n`;
                    }
                }

                // Output a formatted topic
                let formattedTemplate = MAIN_TEMPLATE;
                formattedTemplate = formattedTemplate.replace(TPLTVAR_PREINTERVIEW_TEXT, preinterviewContent);
                formattedTemplate = formattedTemplate.replace(TPLTVAR_INTERVIEWEE_NAME, g_IntervieweeName);
                formattedTemplate = formattedTemplate.replace(TPLTVAR_QUESTIONS_CONTAINER, allQuestions);
                logsContent.value = formattedTemplate;
            }

            // formatQuestion...
            //      q_count:    current questions count
            //      q_header:   the question itself
            //      q_content:  the answer and all the dialog as a response to the question
            function formatQuestion(q_count, q_header, q_content) {
                let formattedTemplate = QUESTION_TEMPLATE;
                formattedTemplate = formattedTemplate.replace(TPLTVAR_QUESTION_NUMBER, q_count);
                formattedTemplate = formattedTemplate.replace(TPLTVAR_QUESTION_TEXT, q_header);
                formattedTemplate = formattedTemplate.replace(TPLTVAR_QUESTION_ANSWER_CONTENT, q_content);
                return formattedTemplate;
            }

            // isMetaLine checks against predefined patterns of irrelevant meta chatter.
            function isMetaLine(line) {
                const patterns = [
                    // OOC chatter is meta...
                    new RegExp(/^\(\(/),

                    // Online list...
                    new RegExp(/The ID of/),

                    // Ads are meta...
                    new RegExp(/^\[(Business |Company )?Advertisement\]/),

                    // Radio chatter is meta...
                    new RegExp(/(^\*\*\[S: [0-9]+ \| CH: [0-9]+\])|(-> (ALL|LSFD|LSPD|LSSD|LAW|DMEC)\])|(^\*\*\[CH: ATC\])/),

                    // (Non-)Emergency calls are meta...
                    new RegExp(/((EMERGENCY CALL)|(^\* Message:)|(^\* Log Number:)|(^\* Phone Number:)|(^\* Location:)|(^\* Situation:))/),
                ];

                // Step through each of the patterns and check if the line has a match...
                for (let i = 0; i < patterns.length; i++) {
                    // There's a match...
                    if (patterns[i].test(line)) {
                        return true;
                    }
                }
                return false;
            }

            function isLineSentByParticipant(line) {
                for (let i = 0; i < g_Participants.length; i++) {
                    if (line.includes(g_Participants[i])) {
                        return true;
                    }
                }
                return false;
            }

            // when check_meta = false, the second operand of the AND operation is true,
            // making it the sole responsibility of String.startsWith to influence the
            // end result of this predicate. Otherwise, isMetaLine() gets to influence it
            // as well. It's only fair.
            function isRoleplayLine(line, check_meta = false) {
                return (line.startsWith('*') || line.startsWith('>')) && (check_meta ? !isMetaLine(line) : true);
            }

            function isInterviewerAme(line) {
                return line.includes(`> ${g_InterviewerName}`);
            }
        </script>


        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    </body>
</html>
